/**
 * Anexo Cogumelos - JavaScript
 * Sistema PMO Digital - ANC
 * Formul√°rio para Produ√ß√£o de Cogumelos Org√¢nicos
 */

const AnexoCogumelo = {
    config: {
        moduleName: 'anexo-cogumelo',
        storageKey: 'anexo_cogumelo_data',
        autoSaveInterval: 30000,
        version: '2.0',
        schemaPath: '/database/schemas/anexo-cogumelo.schema.json'
    },

    state: {
        isModified: false,
        lastSaved: null,
        uploadedFiles: {},
        schemaData: null
    },

    /**
     * Inicializar m√≥dulo
     */
    init() {
        console.log('‚úÖ Inicializando Anexo Cogumelos...');

        // Carregar dados salvos
        this.loadSavedData();

        // Configurar funcionalidades do framework
        this.setupAutoSave();
        this.setupEventListeners();
        this.initDynamicTables();
        this.applyMasks();
        this.calculateProgress();

        console.log('‚úÖ Anexo Cogumelos inicializado!');
    },

    /**
     * Configurar event listeners
     */
    setupEventListeners() {
        const form = document.getElementById('form-anexo-cogumelo');
        if (!form) return;

        // Detectar mudan√ßas
        form.addEventListener('change', () => {
            this.state.isModified = true;
            this.calculateProgress();
        });

        form.addEventListener('input', () => {
            this.state.isModified = true;
        });

        // Submit
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitForm();
        });

        // Configurar auto-save ao navegar
        if (window.AutoSaveNavigation) {
            window.AutoSaveNavigation.setup({
                state: { isModified: false },
                salvar: (isAutoSave) => this.salvar(isAutoSave),
                get state() {
                    return { isModified: AnexoCogumelo.state.isModified };
                }
            });
        }
    },

    /**
     * Aplicar m√°scaras (usa framework)
     */
    applyMasks() {
        // CPF
        document.querySelectorAll('[data-mask="cpf"]').forEach(input => {
            if (typeof PMOField !== 'undefined') {
                PMOField.mask(input, 'cpf');
            }
        });

        // CNPJ
        document.querySelectorAll('[data-mask="cnpj"]').forEach(input => {
            if (typeof PMOField !== 'undefined') {
                PMOField.mask(input, 'cnpj');
            }
        });

        // Telefone
        document.querySelectorAll('[data-mask="phone"]').forEach(input => {
            if (typeof PMOField !== 'undefined') {
                PMOField.mask(input, 'phone');
            }
        });

        // CEP
        document.querySelectorAll('[data-mask="cep"]').forEach(input => {
            if (typeof PMOField !== 'undefined') {
                PMOField.mask(input, 'cep');
            }
        });
    },

    /**
     * Inicializar tabelas din√¢micas
     */
    initDynamicTables() {
        console.log('‚úÖ Tabelas din√¢micas prontas');

        // Atualizar numera√ß√£o das tabelas existentes
        const tabelas = [
            'tabela-cogumelos',
            'tabela-materiais-substrato',
            'tabela-produtos-solo',
            'tabela-estruturas',
            'tabela-pragas',
            'tabela-equipamentos',
            'tabela-insumos',
            'tabela-produtos-higienizacao',
            'tabela-funcionarios'
        ];

        tabelas.forEach(tabelaId => {
            const tbody = document.querySelector(`#${tabelaId} tbody`);
            if (tbody && typeof PMOTable !== 'undefined') {
                PMOTable.updateRowNumbers(tbody);
            }
        });
    },

    /**
     * Configurar auto-save (usa framework)
     */
    setupAutoSave() {
        setInterval(() => {
            if (this.state.isModified) {
                this.salvar(true); // auto-save silencioso
            }
        }, this.config.autoSaveInterval);
    },

    /**
     * Calcular progresso
     */
    calculateProgress() {
        const form = document.getElementById('form-anexo-cogumelo');
        if (!form) return;

        if (typeof PMOProgress !== 'undefined') {
            const progress = PMOProgress.calculate(form);

            // Atualizar progresso no PMOStorageManager
            const pmo = window.PMOStorageManager.getActivePMO();
            if (pmo) {
                window.PMOStorageManager.updateProgresso(pmo.id, 'anexo_cogumelo', progress);
            }
        }
    },

    /**
     * Toggle de se√ß√µes condicionais
     */
    toggleSection(sectionId, show) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = show ? 'block' : 'none';

            // Limpar campos se ocultar
            if (!show) {
                const inputs = section.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
    },

    /**
     * Salvar dados
     */
    salvar(isAutoSave = false) {
        const form = document.getElementById('form-anexo-cogumelo');
        const formData = new FormData(form);
        const dados = {};

        // Converter FormData para objeto
        for (let [key, value] of formData.entries()) {
            // Arrays (campos com [])
            if (key.endsWith('[]')) {
                const arrayKey = key.replace('[]', '');
                if (!dados[arrayKey]) {
                    dados[arrayKey] = [];
                }
                dados[arrayKey].push(value);
            } else {
                dados[key] = value;
            }
        }

        const data = {
            metadata: {
                data_preenchimento: formData.get('data_preenchimento'),
                ultima_atualizacao: new Date().toISOString(),
                versao: '1.0'
            },
            dados: dados,
            uploadedFiles: this.state.uploadedFiles
        };

        // Salvar usando PMOStorageManager
        const pmo = window.PMOStorageManager.getActivePMO();
        if (!pmo) {
            console.warn('Nenhum PMO ativo. Crie o Cadastro Geral primeiro.');
            alert('Crie o Cadastro Geral PMO primeiro!');
            return;
        }

        window.PMOStorageManager.updateFormulario(pmo.id, 'anexo_cogumelo', data);

        this.state.isModified = false;
        this.state.lastSaved = new Date();

        // Atualizar status
        const statusElement = document.getElementById('auto-save-status');
        if (statusElement) {
            statusElement.textContent = `üíæ Salvo √†s ${this.state.lastSaved.toLocaleTimeString()}`;
        }

        if (!isAutoSave) {
            if (typeof PMONotify !== 'undefined') {
                PMONotify.success('Dados salvos com sucesso!');
            } else {
                alert('Dados salvos com sucesso!');
            }
        }

        console.log('‚úÖ Dados salvos:', data);
    },

    /**
     * Carregar dados salvos
     */
    loadSavedData() {
        const pmo = window.PMOStorageManager.getActivePMO();
        if (!pmo || !pmo.dados || !pmo.dados.anexo_cogumelo) {
            console.log('Nenhum dado salvo encontrado.');
            this.loadPMOPrincipal();
            return;
        }

        const data = pmo.dados.anexo_cogumelo;
        console.log(`‚úÖ Dados carregados do PMO: ${pmo.id}`);

        const form = document.getElementById('form-anexo-cogumelo');

        // Carregar arquivos
        if (data.uploadedFiles) {
            this.state.uploadedFiles = data.uploadedFiles;
        }

        // Preencher campos simples
        Object.keys(data.dados).forEach(key => {
            // Arrays
            if (Array.isArray(data.dados[key])) {
                // Arrays s√£o tratados nas tabelas din√¢micas
                return;
            }

            const element = form.querySelector(`[name="${key}"]`);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = data.dados[key] === 'on' || data.dados[key] === true;
                } else if (element.type === 'radio') {
                    const radio = form.querySelector(`[name="${key}"][value="${data.dados[key]}"]`);
                    if (radio) radio.checked = true;
                } else {
                    element.value = data.dados[key];
                }
            }
        });

        if (typeof PMONotify !== 'undefined') {
            PMONotify.info('Dados recuperados do rascunho');
        }

        this.calculateProgress();
        console.log('‚úÖ Dados carregados:', data);
    },

    /**
     * Carregar dados do PMO Principal
     */
    loadPMOPrincipal() {
        try {
            const pmo = window.PMOStorageManager.getActivePMO();
            if (!pmo || !pmo.dados || !pmo.dados.cadastro_geral_pmo) {
                console.log('Nenhum dado do PMO Principal encontrado.');
                return;
            }

            const data = pmo.dados.cadastro_geral_pmo;
            const form = document.getElementById('form-anexo-cogumelo');

            if (!form) return;

            // Preencher campos de identifica√ß√£o
            const nomeField = form.querySelector('[name="nome_fornecedor"]');
            if (nomeField && !nomeField.value) {
                nomeField.value = data.dados?.nome_completo || data.dados?.razao_social || '';
            }

            const unidadeField = form.querySelector('[name="nome_unidade_producao"]');
            if (unidadeField && !unidadeField.value) {
                unidadeField.value = data.dados?.nome_unidade_producao || '';
            }

            const dataField = form.querySelector('[name="data_preenchimento"]');
            if (dataField && !dataField.value) {
                const today = new Date().toISOString().split('T')[0];
                dataField.value = today;
            }

            console.log('Dados carregados do PMO Principal!');
        } catch (error) {
            console.error('Erro ao carregar dados do PMO Principal:', error);
        }
    },

    /**
     * Validar formul√°rio
     */
    validar() {
        const form = document.getElementById('form-anexo-cogumelo');
        const errors = [];
        const warnings = [];

        // Validar campos obrigat√≥rios
        const required = form.querySelectorAll('[required]');
        required.forEach(field => {
            if (!field.value.trim() && field.type !== 'checkbox') {
                errors.push(`Campo obrigat√≥rio n√£o preenchido: ${field.labels[0]?.textContent || field.name}`);
            }
            if (field.type === 'checkbox' && !field.checked) {
                errors.push(`Declara√ß√£o obrigat√≥ria n√£o marcada: ${field.labels[0]?.textContent || field.name}`);
            }
        });

        // Validar CPF
        const cpfFields = form.querySelectorAll('[data-mask="cpf"]');
        cpfFields.forEach(field => {
            if (field.value && typeof PMOValidators !== 'undefined') {
                if (!PMOValidators.validateCPF(field.value)) {
                    errors.push(`CPF inv√°lido: ${field.labels[0]?.textContent || field.name}`);
                }
            }
        });

        // Validar datas
        const dataPreenchimento = document.getElementById('data_preenchimento');
        if (dataPreenchimento && dataPreenchimento.value) {
            const data = new Date(dataPreenchimento.value);
            const hoje = new Date();
            if (data > hoje) {
                warnings.push('Data de preenchimento est√° no futuro');
            }
        }

        // Validar temperaturas
        const tempMin = document.getElementById('temperatura_min');
        const tempMax = document.getElementById('temperatura_max');
        if (tempMin && tempMax && tempMin.value && tempMax.value) {
            if (parseFloat(tempMin.value) >= parseFloat(tempMax.value)) {
                warnings.push('Temperatura m√≠nima deve ser menor que a m√°xima');
            }
        }

        // Validar umidade
        const umidMin = document.getElementById('umidade_relativa_min');
        const umidMax = document.getElementById('umidade_relativa_max');
        if (umidMin && umidMax && umidMin.value && umidMax.value) {
            if (parseFloat(umidMin.value) >= parseFloat(umidMax.value)) {
                warnings.push('Umidade m√≠nima deve ser menor que a m√°xima');
            }
        }

        // Exibir resultados
        if (errors.length > 0) {
            let mensagem = '‚ùå Erros encontrados:\n\n';
            errors.forEach((error, index) => {
                mensagem += `${index + 1}. ${error}\n`;
            });

            if (typeof PMONotify !== 'undefined') {
                PMONotify.error('Corrija os erros antes de enviar');
                console.error(mensagem);
            } else {
                alert(mensagem);
            }
            return false;
        }

        if (warnings.length > 0) {
            let mensagem = '‚ö†Ô∏è Avisos:\n\n';
            warnings.forEach((warning, index) => {
                mensagem += `${index + 1}. ${warning}\n`;
            });

            if (typeof PMONotify !== 'undefined') {
                PMONotify.warning('Verifique os avisos');
                console.warn(mensagem);
            } else {
                alert(mensagem);
            }
        }

        if (errors.length === 0 && warnings.length === 0) {
            if (typeof PMONotify !== 'undefined') {
                PMONotify.success('‚úÖ Formul√°rio v√°lido!');
            } else {
                alert('‚úÖ Formul√°rio v√°lido!');
            }
        }

        return errors.length === 0;
    },

    /**
     * Exportar JSON
     */
    exportarJSON() {
        const form = document.getElementById('form-anexo-cogumelo');
        const formData = new FormData(form);
        const data = {};

        // Converter FormData para objeto estruturado
        for (let [key, value] of formData.entries()) {
            if (key.endsWith('[]')) {
                const arrayKey = key.replace('[]', '');
                if (!data[arrayKey]) {
                    data[arrayKey] = [];
                }
                data[arrayKey].push(value);
            } else {
                data[key] = value;
            }
        }

        // Estruturar conforme schema
        const exportData = {
            metadata: {
                tipo_documento: 'ANEXO_II_COGUMELOS',
                versao_schema: '1.0',
                data_extracao: new Date().toISOString(),
                status_processamento: 'EXPORTADO'
            },
            ...data
        };

        const fileName = `pmo-cogumelos-${new Date().toISOString().split('T')[0]}.json`;

        if (typeof PMOExport !== 'undefined') {
            PMOExport.toJSON(exportData, fileName);
        } else {
            // Fallback manual
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        console.log('‚úÖ JSON exportado:', exportData);
    },

    /**
     * Submeter formul√°rio
     */
    submitForm() {
        // Validar antes de enviar
        if (!this.validar()) {
            return;
        }

        if (confirm('Deseja enviar o formul√°rio para certifica√ß√£o?\n\nAp√≥s o envio, os dados ser√£o processados pela equipe da ANC.')) {
            // Salvar antes de enviar
            this.salvar();

            if (typeof PMONotify !== 'undefined') {
                PMONotify.success('Formul√°rio enviado com sucesso! Em breve voc√™ receber√° um retorno.');
            } else {
                alert('Formul√°rio enviado com sucesso!');
            }

            // Em produ√ß√£o: enviar para servidor
            console.log('‚úÖ Formul√°rio enviado para certifica√ß√£o');

            // Aqui voc√™ adicionaria o c√≥digo para enviar ao servidor
            // fetch('/api/pmo/cogumelo', { method: 'POST', body: formData })
        }
    },

    /**
     * Limpar formul√°rio
     */
    limparFormulario() {
        if (confirm('Deseja realmente limpar todos os dados do formul√°rio?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
            const form = document.getElementById('form-anexo-cogumelo');
            form.reset();

            // Limpar localStorage
            if (typeof PMOStorage !== 'undefined') {
                PMOStorage.clear(this.config.storageKey);
            } else {
                localStorage.removeItem(this.config.storageKey);
            }

            this.state.isModified = false;
            this.state.uploadedFiles = {};
            this.calculateProgress();

            if (typeof PMONotify !== 'undefined') {
                PMONotify.info('Formul√°rio limpo');
            }

            console.log('‚úÖ Formul√°rio limpo');
        }
    }
};

// Inicializar quando DOM carregar
document.addEventListener('DOMContentLoaded', () => {
    AnexoCogumelo.init();
});

// Expor globalmente
window.AnexoCogumelo = AnexoCogumelo;
